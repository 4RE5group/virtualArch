<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emulator</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&amp;display=swap" data-tag="font">
</head>
<body>
    <div class="emulator-container">
        <div class="control-panel">
            <div class="binary-switches" onclick="viewUpdate()">
                <!-- Switches with labels -->
                <div class="switch"><span>ci</span><input type="checkbox"></div>
                <div class="switch"><span>-</span><input type="checkbox"></div>
                <div class="switch"><span>-</span><input type="checkbox"></div>
                <div class="switch"><span>*</span><input type="checkbox"></div>
                <div class="switch"><span>-</span><input type="checkbox"></div>
                <div class="switch"><span>u</span><input type="checkbox"></div>
                <div class="switch"><span>op1</span><input type="checkbox"></div>
                <div class="switch"><span>op0</span><input type="checkbox"></div>
                <div class="switch"><span>zx</span><input type="checkbox"></div>
                <div class="switch"><span>sw</span><input type="checkbox"></div>
                <div class="switch"><span>a</span><input type="checkbox"></div>
                <div class="switch"><span>d</span><input type="checkbox"></div>
                <div class="switch"><span>*a</span><input type="checkbox"></div>
                <div class="switch"><span>lt</span><input type="checkbox"></div>
                <div class="switch"><span>eq</span><input type="checkbox"></div>
                <div class="switch"><span>gt</span><input type="checkbox"></div>
            </div>
            <div class="output-display">
                <span>dec: <p id="decimal_result">0</p></span>
                <span>hex: <p id="hexadecimal_result">0x0</p></span>
                <button class="btn" onclick="asm_exec_opcode(result)">Execute</button>
            </div>
        </div>

        <div class="registers-panel">
            <div class="register"><span>a:</span> <p>0x0</p><span>(0)</span></div>
            <div class="register"><span>d:</span> <p>0x0</p><span>(0)</span></div>
            <div class="register"><span>*a:</span> <p>0x0</p><span>(0)</span></div>
        </div>

        <div class="code-editor-container">
            <div class="line-numbers"></div>
            <textarea class="code-editor" autocomplete="on" oninput="editRom()" name="asmcode" spellcheck="false"></textarea>
            <div class="pc-display">PC: <span id="pc_num">0</span></div>
            <div class="controls">
                <button class="btn" onclick="stepExec()">Step</button>
                <button class="btn" onclick="run()">Run</button>
                <button class="btn" onclick="stop()">Stop</button>
                <button class="btn" onclick="reset()">Reset</button>
            </div>
        </div>
        <canvas id="terminal_screen" width="640" height="480"></canvas>
    </div>
    <script src="src/main.js"></script>
    <script src="./src/terminal.js"></script>
    <script src="./src/utils.js"></script>
    <script>        
        var result = 0;
        // add screen buffer mapping
        addMemoryMapping("screen_buffer", "W", RAMSIZE-(SCREEN_WIDTH*SCREEN_HEIGHT), RAMSIZE-1, function (index, type, value) {
            screen_buffer[registers.d] = value * 255;
            return;
        });
        initScreen();
        displayScreen();


        function viewUpdate()
        {
            result = 0;
            for (i = 0; i < 16; i++) {
                var elem = document.querySelector(".binary-switches").children.item(i).querySelector("input");
                if (elem.checked == true) {
                    result |= (1 << (15 - i));
                }
            }
            document.getElementById("decimal_result").innerText = result;
            document.getElementById("hexadecimal_result").innerText = "0x" + result.toString(16);

            // Helper function to format 16-bit unsigned hex
            function formatHex(value)
            {
                // Convert to 16-bit unsigned integer
                const unsignedValue = value & 0xffff;
                return "0x" + unsignedValue.toString(16).padStart(4, '0');
            }

            // a
            document.querySelector(".registers-panel").children.item(0).children.item(1).innerText = formatHex(registers.a);
            document.querySelector(".registers-panel").children.item(0).children.item(2).innerText = "(" + registers.a + ")";

            // d
            document.querySelector(".registers-panel").children.item(1).children.item(1).innerText = formatHex(registers.d);
            document.querySelector(".registers-panel").children.item(1).children.item(2).innerText = "(" + registers.d + ")";

            // *a
            // document.querySelector(".registers-panel").children.item(2).children.item(1).innerText = formatHex(registers.a_ptr);
            // document.querySelector(".registers-panel").children.item(2).children.item(2).innerText = "(" + registers.a_ptr + ")";
        }

        function editRom() 
        {
            // clear terminal
            console.clear();

            var lines = document.querySelector(".code-editor").value.split("\n");
            let i = 0;
            rom = [];
            lines.forEach(line => {
                // skip comments and new lines
                if (!line.trim().startsWith(";") && line.trim() != "") {
                    let num = asm_to_opcode(line.trim());
                    if (num == -1) {
                        console.error(`error at line ${i+1}`);
                        reset();
                        return;
                    }
                    rom[i] = Number(num);
                }
                else
                    rom[i] == null;
                i++;
            });
            console.log(`successfully writted ${i} op codes to rom!`);
            reset();
        }

        function highlightCurrentLine(pc)
        {
            const lines = document.querySelector('.code-editor').value.split('\n');
            const lineNumbers = document.querySelector('.line-numbers');
            lineNumbers.innerHTML = lines.map((_, i) =>
                `<div${i+1 === pc ? ' class="highlight-line"' : ''}>${i+1}</div>`
            ).join('');
        }

        // Call highlightCurrentLine in stepExec and editRom
        function stepExec()
        {
            registers.pc++;
            if (registers.pc <= 0)
            {
                alert("error: pc is outside range '"+registers.pc+"'");
                return;
            }
            if (registers.pc > rom.length) registers.pc = 1;
            highlightCurrentLine(registers.pc);
            document.getElementById("pc_num").innerText = registers.pc;
            if (rom[registers.pc - 1] != null) // skip comments/non code lines
                asm_exec_opcode(rom[registers.pc - 1]);
            viewUpdate();
        }

        function reset()
        {
            registers.pc = 0;
            document.getElementById("pc_num").innerText = registers.pc + 1;
            highlightCurrentLine(1);
        }

        var stopRun = false;
        var runSpeed = 250;

        function run()
        {
            stopRun = false;
            run_recur();
        }

        function stop()
        {
            stopRun = true;
        }

        function run_recur()
        {
            setTimeout(() => {
                stepExec();
                if (!stopRun)
                    run_recur();
            }, runSpeed);
        }
    </script>
</body>
</html>
